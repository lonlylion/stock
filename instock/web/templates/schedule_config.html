{% extends "layout/default.html" %}

{% block main_content %}
<link rel="stylesheet" href="/static/css/bootstrap-datepicker3.min.css" />

<div style="height: 100%; overflow: hidden;">
    <div class="table-header" style="width:100%; height:35px; background: #f5f5f5; border-bottom: 1px solid #ddd; padding: 5px;">
        <div style="display:inline-block; float:left; height:100%; line-height: 25px;">
            <span style="font-weight: bold; color: #333;">
                定时任务管理
            </span>
        </div>
    </div>

    <div id="scheduleContainer" style="width:100%; height:calc(100% - 95px); margin:0; padding:20px; overflow-y: auto;">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-clock-o"></i> execute_daily_job 定时配置</h4>
                    </div>
                    <div class="panel-body">
                        <div class="alert alert-info" id="scheduleInfo">
                            <i class="fa fa-info-circle"></i> 可以配置多个 cron 表达式来控制 execute_daily_job 的执行时间。
                        </div>

                        <table class="table table-bordered" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Cron 表达式</th>
                                    <th style="width: 35%;">描述</th>
                                    <th style="width: 15%; text-align:center;">启用状态</th>
                                    <th style="width: 20%; text-align:center;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>

                        <button type="button" class="btn btn-success" onclick="addScheduleRow()">
                            <i class="fa fa-plus"></i> 新增执行时间
                        </button>
                        <button type="button" class="btn btn-primary" style="margin-left: 10px;" onclick="saveSchedules()">
                            <i class="fa fa-save"></i> 保存配置
                        </button>
                        <button type="button" class="btn btn-info" style="margin-left: 10px;" onclick="reloadSchedules()">
                            <i class="fa fa-refresh"></i> 重新加载
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-file-text-o"></i> Cron 表达式参考</h4>
                    </div>
                    <div class="panel-body">
                        <p>
                            Cron 格式：<code>分钟 小时 日 月 星期</code>
                        </p>
                        <ul>
                            <li><code>0 9 * * *</code>：每天 09:00 执行</li>
                            <li><code>30 14 * * 1-5</code>：每周一到周五的 14:30 执行</li>
                            <li><code>*/15 9-15 * * 1-5</code>：工作日 9:00-15:59 期间每 15 分钟执行一次</li>
                        </ul>
                        <p>
                            修改配置后请在服务器上更新关联的定时任务工具（如 cron）。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 消息提示 -->
<div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="messageModalLabel">提示</h4>
            </div>
            <div class="modal-body" id="messageContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const scheduleTableBody = document.querySelector('#scheduleTable tbody');

    function showMessage(message, isSuccess = true) {
        const modal = $('#messageModal');
        document.getElementById('messageContent').innerText = message;
        modal.removeClass('modal-success modal-danger');
        modal.addClass(isSuccess ? 'modal-success' : 'modal-danger');
        modal.modal('show');
    }

    function createScheduleRow(entry = {}) {
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td>
                <input type="text" class="form-control cron-input" value="${entry.cron || ''}" placeholder="例如：31 9 * * *" />
            </td>
            <td>
                <input type="text" class="form-control desc-input" value="${entry.description || ''}" placeholder="描述该执行时间" />
            </td>
            <td style="text-align:center;">
                <label class="inline">
                    <input type="checkbox" class="ace enabled-input" ${entry.enabled === false ? '' : 'checked'}>
                    <span class="lbl"></span>
                </label>
            </td>
            <td style="text-align:center;">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeScheduleRow(this)">
                    <i class="fa fa-trash"></i> 删除
                </button>
            </td>
        `;

        scheduleTableBody.appendChild(tr);
    }

    function addScheduleRow() {
        createScheduleRow();
    }

    function removeScheduleRow(button) {
        const row = button.closest('tr');
        if (row) {
            row.remove();
        }
    }

    function collectSchedules() {
        const rows = scheduleTableBody.querySelectorAll('tr');
        const schedules = [];

        rows.forEach(row => {
            const cronInput = row.querySelector('.cron-input');
            const descInput = row.querySelector('.desc-input');
            const enabledInput = row.querySelector('.enabled-input');

            const cronValue = cronInput.value.trim();
            const descValue = descInput.value.trim();

            if (!cronValue) {
                return;
            }

            schedules.push({
                cron: cronValue,
                description: descValue,
                enabled: enabledInput.checked
            });
        });

        return schedules;
    }

    function populateSchedules(data) {
        scheduleTableBody.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
            addScheduleRow();
            return;
        }
        data.forEach(entry => createScheduleRow(entry));
    }

    function reloadSchedules() {
        fetch('/instock/api/get_config')
            .then(resp => resp.json())
            .then(result => {
                if (!result.success) {
                    throw new Error(result.message || '配置加载失败');
                }
                const schedules = result.data && result.data.job_schedules && result.data.job_schedules.execute_daily_job;
                populateSchedules(schedules || []);
            })
            .catch(error => {
                console.error('加载定时配置失败:', error);
                showMessage('加载定时配置失败: ' + error, false);
            });
    }

    function saveSchedules() {
        const schedules = collectSchedules();
        const payload = {
            config_type: 'job_schedules',
            config_data: {
                execute_daily_job: schedules
            }
        };

        fetch('/instock/api/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(resp => resp.json())
        .then(result => {
            if (!result.success) {
                throw new Error(result.message || '保存失败');
            }
            showMessage('定时任务保存成功');
        })
        .catch(error => {
            console.error('保存定时配置失败:', error);
            showMessage('保存失败: ' + error, false);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        reloadSchedules();
    });
</script>
{% end %}
