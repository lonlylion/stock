{% extends "layout/default.html" %}

{% block main_content %}
<link rel="stylesheet" href="/static/css/bootstrap-datepicker3.min.css" />
<link rel="stylesheet" href="/static/css/luckysheet.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/luckysheet-plugins.css" type="text/css"/>
<script type="text/javascript" src="/static/js/luckysheet.umd.js"></script>
<script src="/static/js/luckysheet-plugins.js" type="text/javascript"></script>
<script src="/static/js/FileSaver.js" type="text/javascript"></script>
<script src="/static/js/bootstrap-datepicker.min.js"></script>
<script src="/static/js/bootstrap-datepicker.zh-CN.min.js"></script>

<div style="height: 100%; overflow: hidden;">
    <div class="table-header" style="width:100%; height:35px; background: #f5f5f5; border-bottom: 1px solid #ddd; padding: 5px;">
        <div style="display:inline-block; float:left; height:100%; line-height: 25px;">
            <span style="font-weight: bold; color: #333;">
                {{ web_module_data.name }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;日期：
            </span>
            <input type="hidden" id="dateid_old">
            <input type="text" value="{{ date_now }}" id="dateid" class="input-group-sm form-control date-picker" style="display: inline-block; width: 120px; margin-left: 10px;">
            
            <!-- 搜索链接 -->
            <button type="button" id="openSearchBtn" class="btn btn-info btn-sm" style="margin-left: 20px;" title="打开独立搜索页面" onclick="openSearchPage()">
                <i class="fa fa-search"></i> 搜索股票
            </button>
            
            <!-- 数据更新按钮 -->
            <button type="button" id="updateDataBtn" class="btn btn-warning btn-sm" style="margin-left: 20px;" title="更新当前数据" onclick="showUpdateConfirmationDialog()">
                <i class="fa fa-refresh"></i> 更新数据
            </button>
            
            <!-- 数据更新状态显示 -->
            <span id="updateStatus" style="margin-left: 10px; display: none;" class="label label-info">
                <i class="fa fa-spinner fa-spin"></i> 更新中...
            </span>
        </div>
        <div style="display:inline-block; float:right; height:100%;">
            <button type="button" id="viewKLine" class="btn btn-info btn-sm" style="margin-right: 5px;" title="查看选中股票的K线图">
                <i class="fa fa-line-chart"></i> K线图
            </button>
            <button type="button" id="resetFilter" class="btn btn-primary btn-sm" style="margin-right: 5px;">重置筛选</button>
            <button type="button" id="saveExcel" class="btn btn-success btn-sm">导出Excel</button>
        </div>
    </div>
    
    <!-- Luckysheet容器 -->
    <div id="luckysheet" style="width:100%; height:calc(100% - 95px); margin:0; padding:0;">
        <div id="loadingIndicator" style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa;">
            <div style="text-align: center; color: #6c757d;">
                <div style="margin-bottom: 10px;">
                    <i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i>
                </div>
                <div>正在加载数据...</div>
            </div>
        </div>
    </div>
    
    <div id="statusBar" style="width:100%; height:60px; background: #f9f9f9; border-top: 1px solid #ddd; padding: 10px; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="statusInfo">准备就绪</span>
            
            <!-- 分页控件 -->
            <div id="paginationControls" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>每页显示:</span>
                    <select id="pageSizeSelect" class="form-control" style="width: 80px; height: 30px; font-size: 12px;">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="9999">9999</option>
                    </select>
                    
                    <span id="pageInfo" style="margin: 0 10px;"></span>
                    
                    <div class="btn-group" style="gap: 5px; display: flex;">
                        <button id="firstPageBtn" class="btn btn-default btn-sm" title="首页">
                            <i class="fa fa-angle-double-left"></i>
                        </button>
                        <button id="prevPageBtn" class="btn btn-default btn-sm" title="上一页">
                            <i class="fa fa-angle-left"></i>
                        </button>
                        <button id="nextPageBtn" class="btn btn-default btn-sm" title="下一页">
                            <i class="fa fa-angle-right"></i>
                        </button>
                        <button id="lastPageBtn" class="btn btn-default btn-sm" title="末页">
                            <i class="fa fa-angle-double-right"></i>
                        </button>
                    </div>
                    
                    <span style="margin: 0 10px;">跳转到:</span>
                    <input id="pageJumpInput" type="number" min="1" class="form-control" style="width: 60px; height: 30px; font-size: 12px;">
                    <button id="pageJumpBtn" class="btn btn-primary btn-sm">跳转</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 隐藏的数据容器，用于传递后端数据到前端 -->
    <script type="application/json" id="columnData">{{ column_names_json }}</script>
</div>

<script type="text/javascript">
    // 确保 getUrlVar 函数存在
    if (!$.getUrlVar) {
        $.extend({
            getUrlVars: function(){
                let vars = [], hash;
                const hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for(let i = 0; i < hashes.length; i++)
                {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                }
                return vars;
            },
            getUrlVar: function(name){
                return $.getUrlVars()[name];
            }
        });
    }
    
    const nameParam = $.getUrlVar('table_name');
    let dateParam = "{{ date_now }}";
    
    // 数据更新相关变量
    let updateTaskId = null;
    let updateCheckInterval = null;
    const UPDATE_CHECK_INTERVAL = 2000; // 2秒检查一次
    
    // 分页相关变量
    let currentPage = 1;
    let pageSize = 100;
    let totalPages = 1;
    let totalRecords = 0;
    
    // 搜索相关变量
    let searchKeyword = '';
    let isSearching = false;
    
    // 打开独立搜索页面
    function openSearchPage() {
        const url = `/instock/search?table_name=${encodeURIComponent(nameParam)}&date=${encodeURIComponent(dateParam)}`;
        window.open(url, '_blank');
    }
    
    // 从隐藏的script标签中读取列信息数据
    let colInfos = [];
    try {
        const columnDataElement = document.getElementById('columnData');
        if (columnDataElement) {
            colInfos = JSON.parse(columnDataElement.textContent);
        } else {
            console.error('找不到列数据元素');
        }
    } catch (error) {
        console.error('解析列数据失败:', error);
        colInfos = [];
    }
    
    let currentData = [];
    let filteredData = [];
    
    $(document).ready(function () {
        console.log('DOM 已加载完成');
        console.log('jQuery 版本:', $.fn.jquery);
        console.log('Luckysheet 是否存在:', typeof luckysheet !== 'undefined');
        console.log('nameParam:', nameParam);
        console.log('colInfos:', colInfos);
        
        // 检查必要的依赖
        if (typeof luckysheet === 'undefined') {
            console.error('Luckysheet 库未加载');
            updateStatusBar("Luckysheet 库未加载，请刷新页面重试");
            return;
        }
        
        if (!colInfos || !Array.isArray(colInfos)) {
            console.error('列配置信息无效:', colInfos);
            updateStatusBar("列配置信息错误");
            return;
        }
        
        if (!nameParam) {
            console.warn('未指定表名参数');
            updateStatusBar("缺少表名参数");
            return;
        }
        
        // 初始化Luckysheet
        initLuckysheet();
        
        // 初始化事件
        initEvents();
        
        // 初始化分页事件
        initPaginationEvents();
        
        // 延迟一点时间再加载数据，确保所有依赖都已准备好
        setTimeout(() => {
            loadData(1);
        }, 500);
        
        // 初始化日期选择器
        $(".date-picker").datepicker({
            language: 'zh-CN',
            format: "yyyy-mm-dd",
            showOtherMonths: true,
            selectOtherMonths: false,
            autoclose: true,
            todayHighlight: true
        }).on('changeDate', function(ev){
            // 日期改变时重置到第一页
            currentPage = 1;
            loadData(1);
        });
    });
    
    function initLuckysheet() {
        // 简单的初始化，等待数据加载后再创建实际的表格
        console.log("等待数据加载...");
        updateStatusBar("初始化中...");
        showLoadingIndicator("正在初始化...");
    }
    
    function showLoadingIndicator(message) {
        const container = document.getElementById('luckysheet');
        if (container) {
            container.innerHTML = `
                <div id="loadingIndicator" style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa;">
                    <div style="text-align: center; color: #6c757d;">
                        <div style="margin-bottom: 10px;">
                            <i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i>
                        </div>
                        <div>${message || '正在加载数据...'}</div>
                    </div>
                </div>
            `;
        }
    }
    
    function hideLoadingIndicator() {
        const indicator = document.getElementById('loadingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    // 显示空数据消息
    function showEmptyDataMessage() {
        const container = document.getElementById('luckysheet');
        if (container) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                    <div style="text-align: center; color: #6c757d; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                        <div style="margin-bottom: 20px;">
                            <i class="fa fa-database" style="font-size: 48px; color: #667eea;"></i>
                        </div>
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">暂无数据</h4>
                        <p style="margin-bottom: 20px; color: #6c757d;">当前日期 <strong>${dateParam}</strong> 没有找到相关数据</p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="loadData(1)" class="btn btn-primary btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                <i class="fa fa-refresh"></i> 重新加载
                            </button>
                            <button onclick="loadLatestData()" class="btn btn-info btn-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                <i class="fa fa-clock-o"></i> 加载最新数据
                            </button>
                        </div>
                        <div style="margin-top: 20px; font-size: 12px; color: #999;">
                            <i class="fa fa-info-circle"></i> 提示：可以尝试选择其他日期或重新加载数据
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // 加载最新可用数据
    function loadLatestData() {
        updateStatusBar("正在查找最新可用数据...");
        showLoadingIndicator("正在查找最新可用数据...");
        
        fetch(`/instock/api_data?name=${nameParam}&page=1&page_size=${pageSize}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Latest data response:', result);
                
                let data, pagination;
                if (result.data && result.pagination) {
                    data = result.data;
                    pagination = result.pagination;
                    totalRecords = pagination.total;
                    totalPages = pagination.total_pages;
                    currentPage = 1;
                } else if (Array.isArray(result)) {
                    data = result;
                    totalRecords = data.length;
                    totalPages = 1;
                    currentPage = 1;
                } else {
                    throw new Error('无效的响应格式');
                }
                
                if (data.length > 0) {
                    // 使用最新数据的日期更新日期选择器
                    const latestDate = '2025-08-22'; // 这里可以从数据中获取实际的最新日期
                    document.getElementById('dateid').value = latestDate;
                    dateParam = latestDate;
                    
                    currentData = data;
                    filteredData = data.slice();
                    
                    displayDataInLuckysheet(data);
                    updatePaginationControls();
                    updateStatusBar(`已加载最新可用数据 (${latestDate})`);
                } else {
                    hideLoadingIndicator();
                    showEmptyDataMessage();
                    hidePaginationControls();
                    updateStatusBar("系统中暂无任何数据");
                }
            })
            .catch(error => {
                console.error('加载最新数据失败:', error);
                hideLoadingIndicator();
                updateStatusBar("加载最新数据失败: " + error.message);
                
                // 显示错误信息但保留空数据页面
                const container = document.getElementById('luckysheet');
                if (container) {
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                            <div style="text-align: center; color: #dc3545; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                                <div style="margin-bottom: 20px;">
                                    <i class="fa fa-exclamation-triangle" style="font-size: 48px; color: #f093fb;"></i>
                                </div>
                                <h4 style="color: #2c3e50; margin-bottom: 15px;">加载失败</h4>
                                <p style="margin-bottom: 20px; color: #6c757d;">无法获取数据: ${error.message}</p>
                                <button onclick="loadData(1)" class="btn btn-primary btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                    <i class="fa fa-refresh"></i> 重试
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
    }
    
    // 处理数据中的时间戳
    function processTimestampData(data) {
        if (!data || !Array.isArray(data)) return data;
        
        return data.map(record => {
            const processedRecord = {};
            for (const [key, value] of Object.entries(record)) {
                // 更严格的时间戳检测：
                // 1. 必须是数字
                // 2. 字段名包含时间相关关键字
                // 3. 数值在合理的时间戳范围内
                const isTimestampField = key && (
                    key.toLowerCase().includes('time') ||
                    key.toLowerCase().includes('date') ||
                    key.toLowerCase().includes('created') ||
                    key.toLowerCase().includes('updated') ||
                    key.toLowerCase().includes('timestamp') ||
                    key.toLowerCase().includes('_at') ||
                    key.endsWith('_time') ||
                    key.endsWith('_date')
                );
                
                if (typeof value === 'number' && isTimestampField) {
                    try {
                        let date;
                        // 根据数值大小判断时间戳精度
                        if (value > 1e18) {
                            // 纳秒级时间戳 (19位数字)
                            date = new Date(value / 1e6);
                        } else if (value > 1e15) {
                            // 微秒级时间戳 (16-18位数字)
                            date = new Date(value / 1e3);
                        } else if (value > 1e12) {
                            // 毫秒级时间戳 (13-15位数字)
                            date = new Date(value);
                        } else if (value > 1e9) {
                            // 秒级时间戳 (10-12位数字)
                            date = new Date(value * 1000);
                        } else if (value > 100 && value < 1e8) {
                            // 可能是从某个基准日期开始的天数，比如Excel日期序列号
                            // Excel日期从1900-01-01开始，但要注意闰年bug
                            // 通用做法：从1970-01-01开始的天数
                            const baseDate = new Date('1970-01-01T00:00:00Z');
                            date = new Date(baseDate.getTime() + (value) * 24 * 60 * 60 * 1000);
                        } else {
                            // 数值太小或太大，不是时间戳，保持原值
                            processedRecord[key] = value;
                            continue;
                        }
                        
                        // 检查转换后的日期是否在合理范围内 (1970-2100年)
                        const year = date.getFullYear();
                        if (!isNaN(date.getTime()) && year >= 1970 && year <= 2100) {
                            // 根据字段名决定格式，避免时区问题
                            if (key.toLowerCase().includes('date') && 
                                date.getUTCHours() === 0 && date.getUTCMinutes() === 0 && date.getUTCSeconds() === 0) {
                                // 如果字段名包含date且时间部分为00:00:00，只显示日期
                                // 直接使用UTC日期避免时区偏移
                                const year = date.getUTCFullYear();
                                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(date.getUTCDate()).padStart(2, '0');
                                processedRecord[key] = `${year}-${month}-${day}`;
                            } else {
                                // 显示完整的日期时间，使用本地时区
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const hours = String(date.getHours()).padStart(2, '0');
                                const minutes = String(date.getMinutes()).padStart(2, '0');
                                const seconds = String(date.getSeconds()).padStart(2, '0');
                                processedRecord[key] = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                            }
                        } else {
                            // 转换后的日期不合理，保持原值
                            processedRecord[key] = value;
                        }
                    } catch (e) {
                        // 转换失败，保持原值
                        processedRecord[key] = value;
                    }
                } else {
                    processedRecord[key] = value;
                }
            }
            return processedRecord;
        });
    }
    
    function loadData(page = 1) {
        const dateParam_old = document.getElementById("dateid_old").value;
        dateParam = document.getElementById('dateid').value;
        
        if (dateParam_old === dateParam && page === currentPage) return;
        document.getElementById("dateid_old").value = dateParam;
        
        currentPage = page;
        
        updateStatusBar("加载数据中...");
        showLoadingIndicator("正在加载数据...");
        
        // 构建请求URL，包含分页参数
        let url = `/instock/api_data?name=${nameParam}&date=${dateParam}&page=${currentPage}&page_size=${pageSize}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Data loaded:', result);
                
                // 检查响应格式
                let data, pagination;
                if (result.data && result.pagination) {
                    // 新的分页格式
                    data = result.data;
                    pagination = result.pagination;
                    totalRecords = pagination.total;
                    totalPages = pagination.total_pages;
                    currentPage = pagination.page;
                } else if (Array.isArray(result)) {
                    // 兼容旧格式（无分页）
                    data = result;
                    totalRecords = data.length;
                    totalPages = 1;
                    currentPage = 1;
                } else {
                    throw new Error('无效的响应格式');
                }
                
                console.log('分页信息:', { currentPage, totalPages, totalRecords, pageSize });
                
                // 处理数据为空的情况
                if (data.length === 0) {
                    console.warn(`No data found for date ${dateParam}`);
                    
                    // 如果是第一页且总记录数为0，说明真的没有数据
                    if (currentPage === 1 && totalRecords === 0) {
                        console.log('确认无数据，显示空数据页面');
                        hideLoadingIndicator();
                        showEmptyDataMessage();
                        hidePaginationControls();
                        updateStatusBar("当前日期无数据");
                        return;
                    }
                    
                    // 如果不是第一页但数据为空，可能是页码超出范围
                    if (currentPage > 1) {
                        console.log('页码可能超出范围，返回第一页');
                        loadData(1);
                        return;
                    }
                    
                    // 其他情况（第一页但可能有历史数据）直接显示空数据页面
                    hideLoadingIndicator();
                    showEmptyDataMessage();
                    hidePaginationControls();
                    updateStatusBar("当前日期无数据");
                    return;
                } else {
                    // 有数据的正常情况
                    console.log('数据加载成功，记录数:', data.length);
                    currentData = data;
                    filteredData = data.slice();
                    displayDataInLuckysheet(data);
                    updatePaginationControls();
                    updateStatusBar();
                }
            })
            .catch(error => {
                console.error('加载数据失败:', error);
                hideLoadingIndicator();
                updateStatusBar("数据加载失败: " + error.message);
                
                // 显示错误信息
                const container = document.getElementById('luckysheet');
                if (container) {
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                            <div style="text-align: center; color: #dc3545; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                                <div style="margin-bottom: 20px;">
                                    <i class="fa fa-exclamation-triangle" style="font-size: 48px; color: #f093fb;"></i>
                                </div>
                                <h4 style="color: #2c3e50; margin-bottom: 15px;">数据加载失败</h4>
                                <p style="margin-bottom: 10px; color: #6c757d;">错误信息: ${error.message}</p>
                                <div style="margin-bottom: 20px; font-size: 12px; color: #999;">
                                    请检查网络连接或稍后重试
                                </div>
                                <button onclick="loadData(1)" class="btn btn-primary btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                    <i class="fa fa-refresh"></i> 重新加载
                                </button>
                            </div>
                        </div>
                    `;
                }
                hidePaginationControls();
            });
    }
    
    function displayDataInLuckysheet(data) {
        console.log('displayDataInLuckysheet 开始，数据长度:', data ? data.length : 0);
        
        if (!data || data.length === 0) {
            console.log('displayDataInLuckysheet: 数据为空');
            hideLoadingIndicator();
            showEmptyDataMessage();
            updateStatusBar("无数据显示");
            return;
        }
        
        // 处理时间戳数据
        const processedData = processTimestampData(data);
        
        // 更新全局数据变量
        currentData = processedData;
        filteredData = processedData.slice();
        
        console.log('显示数据，记录数:', processedData.length);
        console.log('列信息:', colInfos);
        
        // 检查 colInfos 是否有效
        if (!colInfos || !Array.isArray(colInfos) || colInfos.length === 0) {
            console.error('列信息无效:', colInfos);
            updateStatusBar("列配置错误");
            showFallbackTable(processedData);
            return;
        }
        
        // 检查数据样本
        if (processedData.length > 0) {
            console.log('数据样本:', processedData[0]);
            console.log('数据字段:', Object.keys(processedData[0]));
        }
        
        // 转换 colInfos 格式（适配后端返回的格式）
        const normalizedColInfos = colInfos.map(col => {
            if (typeof col === 'object' && col.value && col.caption) {
                // 后端格式：{ value: "field_name", caption: "显示名" }
                return {
                    field: col.value,
                    displayText: col.caption
                };
            } else if (typeof col === 'object' && col.field) {
                // 已经是正确格式
                return col;
            } else {
                console.warn('未知的列格式:', col);
                return {
                    field: col.toString(),
                    displayText: col.toString()
                };
            }
        });
        
        console.log('标准化后的列信息:', normalizedColInfos);
        
        try {
            // 构建 celldata 格式的数据
            const celldata = [];
            
            console.log('开始构建celldata，列信息:', normalizedColInfos);
            
            // 添加表头
            normalizedColInfos.forEach((col, colIndex) => {
                if (!col) {
                    console.warn('空的列配置在索引:', colIndex);
                    return;
                }
                
                const headerText = col.displayText || col.field || col.name || `列${colIndex + 1}`;
                console.log(`添加表头列${colIndex}: ${headerText}, 字段: ${col.field}`);
                
                celldata.push({
                    r: 0,
                    c: colIndex,
                    v: {
                        v: headerText,
                        ct: { fa: "General", t: "g" },
                        m: headerText,
                        bg: "#e8f5e9",
                        fc: "#2e7d32",
                        bl: 1,
                        fs: 12,
                        ht: 1,
                        vt: 1
                    }
                });
            });
            
            console.log('表头添加完成，当前celldata长度:', celldata.length);
            
            // 添加数据行
            const displayData = processedData;
            displayData.forEach((row, rowIndex) => {
                if (!row || typeof row !== 'object') {
                    console.warn('无效的行数据:', rowIndex, row);
                    return;
                }
                
                normalizedColInfos.forEach((col, colIndex) => {
                    if (!col || !col.field) {
                        console.warn('列配置缺少field属性:', colIndex, col);
                        return;
                    }
                    
                    let value = row[col.field];
                    if (value === null || value === undefined) value = '';
                    
                    // 处理日期格式
                    if (col.field && col.field.includes('date') && value) {
                        try {
                            // 对于ISO格式的日期字符串，直接提取日期部分避免时区问题
                            if (typeof value === 'string' && value.includes('T')) {
                                // 如果是ISO格式 "2025-09-08T00:00:00"，直接提取日期部分
                                value = value.split('T')[0];
                            } else {
                                // 其他格式尝试转换
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    // 使用本地日期避免时区偏移
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    value = `${year}-${month}-${day}`;
                                }
                            }
                        } catch (e) {
                            console.warn('日期格式化错误:', value, e);
                        }
                    }
                    
                    // 处理数字格式
                    let cellValue;
                    if (typeof value === 'number' && !isNaN(value)) {
                        // 对于数字，保持原始精度，但格式化显示
                        if (Number.isInteger(value)) {
                            cellValue = {
                                v: value,
                                ct: { fa: "0", t: "n" },
                                m: value.toString()
                            };
                        } else {
                            // 浮点数保留适当小数位
                            const decimalPlaces = Math.abs(value) < 1 ? 4 : 2;
                            cellValue = {
                                v: value,
                                ct: { fa: `0.${'0'.repeat(decimalPlaces)}`, t: "n" },
                                m: value.toFixed(decimalPlaces)
                            };
                        }
                    } else {
                        const strValue = String(value);
                        cellValue = {
                            v: strValue,
                            ct: { fa: "General", t: "g" },
                            m: strValue
                        };
                    }
                    
                    // 新增涨跌幅颜色处理
                    if (col.field && (col.field.includes('change') || col.field.includes('涨跌幅')) && typeof value === 'number') {
                        if (value > 0) {
                            cellValue.bg = "#ffebee"; // 红色背景
                            cellValue.fc = "#d32f2f"; // 红色文字
                        } else if (value < 0) {
                            cellValue.bg = "#e8f5e8"; // 绿色背景
                            cellValue.fc = "#388e3c"; // 绿色文字
                        }
                    }
                    
                    celldata.push({
                        r: rowIndex + 1,
                        c: colIndex,
                        v: cellValue
                    });
                });
            });
            
            console.log('构建 celldata 完成，单元格数:', celldata.length);
            console.log('验证 celldata 样本:', celldata.slice(0, 5));
            
            // 验证数据完整性
            if (celldata.length === 0) {
                console.error('celldata 为空，无法创建表格');
                showFallbackTable(processedData);
                return;
            }
            
            // 验证列信息
            const validColumns = normalizedColInfos.filter(col => col && col.field);
            if (validColumns.length === 0) {
                console.error('没有有效的列配置');
                showFallbackTable(processedData);
                return;
            }
            
            console.log('有效列数:', validColumns.length);
            console.log('数据行数:', processedData.length);
            
            // 销毁现有的 Luckysheet 实例
            if (typeof luckysheet !== 'undefined' && luckysheet.destroy) {
                try {
                    luckysheet.destroy();
                    console.log('成功销毁旧的 Luckysheet 实例');
                } catch (e) {
                    console.log('销毁实例时出错，忽略:', e);
                }
            }
            
            // 清空容器
            const container = document.getElementById('luckysheet');
            if (!container) {
                console.error('找不到 luckysheet 容器');
                return;
            }
            
            // 隐藏加载指示器
            hideLoadingIndicator();
            container.innerHTML = '';
            
            // 确保 luckysheet 全局变量存在
            if (typeof luckysheet === 'undefined') {
                console.error('Luckysheet 库未加载');
                updateStatusBar("Luckysheet 库未加载");
                showFallbackTable(processedData);
                return;
            }
            
            // 给容器一个小的延迟确保DOM完全清空
            setTimeout(() => {
                try {
                    // 计算合适的列宽
                    const columnlen = {};
                    normalizedColInfos.forEach((col, index) => {
                        // 根据列名和数据内容计算列宽
                        let maxWidth = (col.displayText || col.field || '').length * 12 + 30;
                        
                        // 检查该列数据的最大长度
                        if (displayData.length > 0) {
                            const sampleValues = displayData.slice(0, Math.min(10, displayData.length));
                            for (const row of sampleValues) {
                                const value = row[col.field];
                                if (value !== null && value !== undefined) {
                                    const strLen = String(value).length;
                                    maxWidth = Math.max(maxWidth, strLen * 10 + 30);
                                }
                            }
                        }
                        
                        // 设置合理的列宽范围，确保中文显示正常
                        columnlen[index] = Math.min(Math.max(maxWidth, 100), 250);
                    });
                    
                    console.log('计算的列宽:', columnlen);
                    
                    console.log('开始创建 Luckysheet 实例');
                    console.log('celldata 长度:', celldata.length);
                    console.log('列数:', normalizedColInfos.length);
                    console.log('行数:', displayData.length);
                    console.log('列宽配置:', columnlen);
                    
                    // 直接使用备用表格显示，避免Luckysheet的复杂问题
                    showFallbackTable(processedData);
                    
                } catch (createError) {
                    console.error('创建表格失败:', createError);
                    updateStatusBar("表格创建失败: " + createError.message);
                    showFallbackTable(processedData);
                }
            }, 100);
            
        } catch (error) {
            console.error('显示数据时发生错误:', error);
            updateStatusBar("数据显示失败: " + error.message);
            
            // 尝试显示一个简单的表格作为备用方案
            showFallbackTable(processedData);
        }
    }
    
    function showFallbackTable(data) {
        console.log('使用备用表格显示方案');
        const container = document.getElementById('luckysheet');
        
        if (!container) {
            console.error('找不到容器元素');
            return;
        }
        
        // 隐藏加载指示器
        hideLoadingIndicator();
        
        // 检查是否有有效的列信息
        let validColInfos = colInfos;
        if (!validColInfos || !Array.isArray(validColInfos) || validColInfos.length === 0) {
            console.warn('列信息无效，使用数据字段作为列');
            if (data.length > 0 && typeof data[0] === 'object') {
                validColInfos = Object.keys(data[0]).map(key => ({
                    field: key,
                    displayText: key
                }));
            } else {
                console.error('无法确定列信息');
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">无法显示数据：列配置错误</div>';
                return;
            }
        } else {
            // 标准化列信息格式
            validColInfos = validColInfos.map(col => {
                if (typeof col === 'object' && col.value && col.caption) {
                    return {
                        field: col.value,
                        displayText: col.caption
                    };
                } else if (typeof col === 'object' && col.field) {
                    return col;
                } else {
                    return {
                        field: col.toString(),
                        displayText: col.toString()
                    };
                }
            });
        }
        
        let html = '<div style="overflow: auto; height: 100%; background: #fff;">';
        html += '<style>';
        html += '.stock-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 0; }';
        html += '.stock-table th { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #4caf50; padding: 10px 8px; text-align: center; font-weight: bold; color: #2e7d32; position: sticky; top: 0; z-index: 10; }';
        html += '.stock-table td { border: 1px solid #e0e0e0; padding: 8px; text-align: right; white-space: nowrap; }';
        html += '.stock-table td:first-child, .stock-table td:nth-child(2) { text-align: left; }'; // 股票代码和名称左对齐
        html += '.stock-table tr:nth-child(even) { background: #fafafa; }';
        html += '.stock-table tr:hover { background: #e3f2fd; }';
        html += '.positive { color: #d32f2f; font-weight: bold; }'; // 正数红色
        html += '.negative { color: #388e3c; font-weight: bold; }'; // 负数绿色
        html += '</style>';
        html += '<table class="stock-table">';
        
        // 表头
        html += '<thead><tr>';
        validColInfos.forEach(col => {
            const header = (col && (col.displayText || col.field)) || '未知列';
            html += `<th>${header}</th>`;
        });
        html += '</tr></thead>';
        
        // 数据行
        html += '<tbody>';
        const maxRows = Math.min(data.length, pageSize);
        for (let i = 0; i < maxRows; i++) {
            const row = data[i];
            html += '<tr>';
            validColInfos.forEach(col => {
                if (!col || !col.field) {
                    html += '<td></td>';
                    return;
                }
                
                let value = row[col.field];
                let cssClass = '';
                
                if (value === null || value === undefined) {
                    value = '';
                } else {
                    // 处理数字格式并添加颜色
                    if (typeof value === 'number') {
                        // 检查是否是涨跌幅相关字段
                        if (col.field && (col.field.includes('change') || 
                                         col.field.includes('涨跌幅') || 
                                         col.field.includes('pct') || 
                                         col.field === 'p_change')) {
                            if (value > 0) {
                                cssClass = 'positive';
                                value = '+' + value.toFixed(2) + '%';
                            } else if (value < 0) {
                                cssClass = 'negative';
                                value = value.toFixed(2) + '%';
                            } else {
                                value = value.toFixed(2) + '%';
                            }
                        } else {
                            // 其他数字字段
                            if (Number.isInteger(value)) {
                                value = value.toLocaleString();
                            } else {
                                value = value.toFixed(2);
                            }
                        }
                    } else {
                        // 处理日期格式
                        if (col.field && col.field.includes('date') && value) {
                            try {
                                // 对于ISO格式的日期字符串，直接提取日期部分避免时区问题
                                if (typeof value === 'string' && value.includes('T')) {
                                    // 如果是ISO格式 "2025-09-08T00:00:00"，直接提取日期部分
                                    value = value.split('T')[0];
                                } else {
                                    // 其他格式尝试转换
                                    const date = new Date(value);
                                    if (!isNaN(date.getTime())) {
                                        // 使用本地日期避免时区偏移
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        value = `${year}-${month}-${day}`;
                                    }
                                }
                            } catch (e) {
                                // 保持原值
                            }
                        }
                    }
                }
                
                const cellClass = cssClass ? ` class="${cssClass}"` : '';
                html += `<td${cellClass}>${String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>`;
            });
            html += '</tr>';
        }
        html += '</tbody></table>';
        
        if (totalPages > 1) {
            html += `<div style="padding: 15px; text-align: center; color: #666; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); border-top: 2px solid #4caf50; margin-top: 0;">
                        <i class="fa fa-info-circle" style="color: #4caf50;"></i> 当前显示第 <strong>${currentPage}</strong> 页，每页 <strong>${pageSize}</strong> 条记录，总共 <strong>${totalRecords}</strong> 条记录
                     </div>`;
        }
        
        html += '</div>';
        
        container.innerHTML = html;
        updateStatusBar(`显示第${currentPage}页数据 (共${totalRecords}条)`);
    }
    
    function initEvents() {
        // 导出Excel
        document.getElementById('saveExcel').onclick = function() {
            if (typeof luckysheet !== 'undefined' && luckysheet.exportXlsx) {
                const filename = `${nameParam}_${dateParam}_第${currentPage}页`;
                luckysheet.exportXlsx({
                    title: filename,
                    success: function(blobUrl) {
                        // 创建下载链接
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = `${filename}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        updateStatusBar("导出成功");
                    },
                    error: function(error) {
                        console.error('导出失败:', error);
                        updateStatusBar("导出失败");
                    }
                });
            } else {
                // 备用导出方案
                exportToCSV();
            }
        };
        
        // K线图查看功能
        document.getElementById('viewKLine').onclick = function() {
            viewKLineChart();
        };
        
        // 重置筛选
        document.getElementById('resetFilter').onclick = function() {
            // 重新加载数据
            filteredData = currentData.slice();
            displayDataInLuckysheet(filteredData);
            updateStatusBar("筛选已重置");
        };
    }
    
    // 初始化分页事件
    function initPaginationEvents() {
        // 页面大小选择
        document.getElementById('pageSizeSelect').onchange = function() {
            pageSize = parseInt(this.value);
            currentPage = 1; // 重置到第一页
            loadData(1);
        };
        
        // 分页按钮
        document.getElementById('firstPageBtn').onclick = function() {
            if (currentPage > 1) {
                loadData(1);
            }
        };
        
        document.getElementById('prevPageBtn').onclick = function() {
            if (currentPage > 1) {
                loadData(currentPage - 1);
            }
        };
        
        document.getElementById('nextPageBtn').onclick = function() {
            if (currentPage < totalPages) {
                loadData(currentPage + 1);
            }
        };
        
        document.getElementById('lastPageBtn').onclick = function() {
            if (currentPage < totalPages) {
                loadData(totalPages);
            }
        };
        
        // 页面跳转
        document.getElementById('pageJumpBtn').onclick = function() {
            const targetPage = parseInt(document.getElementById('pageJumpInput').value);
            if (targetPage >= 1 && targetPage <= totalPages && targetPage !== currentPage) {
                loadData(targetPage);
            }
        };
        
        // 回车键跳转
        document.getElementById('pageJumpInput').onkeypress = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('pageJumpBtn').click();
            }
        };
    }
    
    function exportToCSV() {
        const keyword = document.getElementById('searchInput').value.trim();
        if (keyword === '') {
            clearSearch();
            return;
        }
        
        loadData(1, keyword);
        updateSearchUI(true);
    }
    
    // 清除搜索
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        searchKeyword = '';
        isSearching = false;
        currentPage = 1;
        loadData(1, '');
        updateSearchUI(false);
    }
    
    // 更新搜索相关UI
    function updateSearchUI(searching) {
        const clearBtn = document.getElementById('clearSearchBtn');
        if (searching) {
            clearBtn.style.display = 'inline-block';
        } else {
            clearBtn.style.display = 'none';
        }
    }
    
    // 更新分页控件
    function updatePaginationControls() {
        const paginationControls = document.getElementById('paginationControls');
        const pageInfo = document.getElementById('pageInfo');
        const pageJumpInput = document.getElementById('pageJumpInput');
        
        if (totalPages > 1) {
            paginationControls.style.display = 'block';
            pageInfo.textContent = `第 ${currentPage} 页，共 ${totalPages} 页 (总计 ${totalRecords} 条记录)`;
            pageJumpInput.max = totalPages;
            pageJumpInput.value = currentPage;
            
            // 更新按钮状态
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
        } else {
            paginationControls.style.display = 'none';
        }
    }
    
    // 隐藏分页控件
    function hidePaginationControls() {
        const paginationControls = document.getElementById('paginationControls');
        paginationControls.style.display = 'none';
    }
    
    function exportToCSV() {
        if (!currentData || currentData.length === 0) {
            alert('当前页没有数据可导出');
            return;
        }
        
        // 询问用户是否导出所有数据
        const exportAll = confirm(`当前页有 ${currentData.length} 条记录，总共有 ${totalRecords} 条记录。\n\n点击"确定"导出当前页数据，点击"取消"导出所有数据。`);
        
        let dataToExport = currentData;
        let filename = `${nameParam}_${dateParam}_第${currentPage}页`;
        
        if (!exportAll) {
            // 如果用户选择导出所有数据，需要重新请求
            if (totalRecords > pageSize) {
                alert('导出所有数据功能需要后端支持，当前只能导出当前页数据。');
                return;
            }
            filename = `${nameParam}_${dateParam}_全部数据`;
        }
        
        // 创建CSV内容
        const normalizedColInfos = colInfos.map(col => {
            if (typeof col === 'object' && col.value && col.caption) {
                return { field: col.value, displayText: col.caption };
            } else if (typeof col === 'object' && col.field) {
                return col;
            } else {
                return { field: col.toString(), displayText: col.toString() };
            }
        });
        
        const headers = normalizedColInfos.map(col => col.displayText || col.field);
        const csvContent = [
            headers.join(','),
            ...dataToExport.map(row => 
                normalizedColInfos.map(col => {
                    const value = row[col.field] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                }).join(',')
            )
        ].join('\n');
        
        // 创建Blob并下载
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        updateStatusBar("CSV导出成功");
    }
    
    // K线图查看相关函数
    function viewKLineChart() {
        // 获取当前选中的行数据
        const selectedData = getSelectedRowData();
        
        if (!selectedData || !selectedData.code) {
            // 如果没有选中行，显示输入对话框
            showStockCodeInputDialog();
            return;
        }
        
        const code = selectedData.code;
        const name = selectedData.name || selectedData.股票名称 || '';
        const date = document.getElementById('dateid').value;
        
        openKLineWindow(code, name, date);
    }
    
    // 获取选中行的数据
    function getSelectedRowData() {
        try {
            // 尝试从 Luckysheet 获取选中数据
            if (typeof luckysheet !== 'undefined' && luckysheet.getSelection) {
                const selection = luckysheet.getSelection();
                if (selection && selection.length > 0) {
                    const range = selection[0];
                    if (range.row && range.row.length > 0) {
                        const rowIndex = range.row[0];
                        if (rowIndex > 0 && currentData && currentData[rowIndex - 1]) {
                            return currentData[rowIndex - 1];
                        }
                    }
                }
            }
        } catch (error) {
            console.log('从 Luckysheet 获取选中数据失败:', error);
        }
        
        return null;
    }
    
    // 显示股票代码输入对话框
    function showStockCodeInputDialog() {
        const code = prompt('请输入股票代码（例如：600000）:');
        if (code && code.trim()) {
            const cleanCode = code.trim();
            if (/^\d{6}$/.test(cleanCode)) {
                const date = document.getElementById('dateid').value;
                openKLineWindow(cleanCode, '', date);
            } else {
                alert('请输入正确的6位股票代码');
            }
        }
    }
    
    // 打开K线图窗口
    function openKLineWindow(code, name, date) {
        let url = `/instock/data/indicators?code=${encodeURIComponent(code)}`;
        if (name) {
            url += `&name=${encodeURIComponent(name)}`;
        }
        if (date) {
            url += `&date=${encodeURIComponent(date)}`;
        }
        
        window.open(url, '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
        updateStatusBar(`正在打开 ${code} ${name} 的K线图...`);
    }
    
    function updateStatusBar(message) {
        const statusElement = document.getElementById('statusInfo');
        if (message) {
            statusElement.textContent = message;
        } else {
            const visibleRecords = currentData.length;
            const startRecord = (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(startRecord + visibleRecords - 1, totalRecords);
            
            let statusText = `<i class="fa fa-info-circle"></i>`;
            
            if (totalPages > 1) {
                statusText += ` 显示第 <b>${startRecord}-${endRecord}</b> 条，共 <b>${totalRecords}</b> 条记录`;
            } else {
                statusText += ` 总记录数：<b>${totalRecords}</b> | 显示记录数：<b>${visibleRecords}</b>`;
            }
            
            statusText += ` | 表格：${nameParam || '未知'}`;
            statusElement.innerHTML = statusText;
        }
    }
    

    
    // 日期格式化函数
    Date.prototype.format = function (format) {
        const o = {
            "y": "" + this.getFullYear(),
            "M": "" + (this.getMonth() + 1),
            "d": "" + this.getDate(),
            "h": "" + this.getHours(),
        };
        return Object.keys(o).reduce((pre, k) => 
            (new RegExp("(" + k + "+)").test(pre)) ? 
            (pre.replace(RegExp.$1, RegExp.$1.length === 1 ? o[k] : o[k].padStart(2, "0"))) : 
            pre, format);
    };
    
    // 细粒度数据更新功能
    let currentJobType = null;
    let currentTaskId = null;
    let updatePollInterval = null;
    
    function showJobUpdateDialog() {
        // 设置当前页面信息
        document.getElementById('currentPageName').textContent = "{{ web_module_data.name }}";
        document.getElementById('currentTableName').textContent = "{{ web_module_data.table_name }}";
        
        // 显示更新对话框
        $('#jobUpdateModal').modal('show');
        
        // 加载更新选项
        loadJobUpdateOptions();
    }
    
    function loadJobUpdateOptions() {
        const tableName = nameParam;
        
        // 获取当前页面对应的job映射
        fetch(`/instock/menu_to_job?table=${tableName}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    displayJobOptions(result.data);
                } else {
                    showJobOptionsError('获取更新选项失败');
                }
            })
            .catch(error => {
                console.error('加载更新选项失败:', error);
                showJobOptionsError('网络错误');
            });
    }
    
    function displayJobOptions(mappingData) {
        const optionsContainer = document.getElementById('jobUpdateOptions');
        
        if (!mappingData.job_type) {
            optionsContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle"></i>
                    <strong>未找到对应的更新选项</strong>
                    <p>当前页面没有对应的数据更新脚本</p>
                </div>
            `;
            return;
        }
        
        const jobInfo = mappingData.job_info;
        currentJobType = mappingData.job_type;
        
        optionsContainer.innerHTML = `
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fa fa-cogs"></i> ${jobInfo.name}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p><strong>描述:</strong> ${jobInfo.description}</p>
                            <p><strong>脚本:</strong> ${jobInfo.script}</p>
                            <p><strong>影响数据表:</strong> ${jobInfo.tables.join(', ') || '多个数据表'}</p>
                            
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="radio" name="updateOption" id="quickUpdate" value="${jobInfo.type}" checked>
                                <label class="form-check-label" for="quickUpdate">
                                    <strong>快速更新</strong> - 仅更新当前页面的数据
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="updateOption" id="fullUpdate" value="complete">
                                <label class="form-check-label" for="fullUpdate">
                                    <strong>完整更新</strong> - 执行完整的数据更新流程
                                </label>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-info btn-sm" onclick="showAllJobOptions()">
                                    <i class="fa fa-list"></i> 查看所有更新选项
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 显示开始按钮
        document.getElementById('startUpdateBtn').style.display = 'block';
    }
    
    function showAllJobOptions() {
        fetch('/instock/job_list')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    displayAllJobOptions(result.data);
                }
            })
            .catch(error => {
                console.error('获取所有job选项失败:', error);
            });
    }
    
    function displayAllJobOptions(jobs) {
        const optionsContainer = document.getElementById('jobUpdateOptions');
        
        let html = '<div class="row">';
        
        // 按类型分组显示
        const jobTypes = {};
        Object.keys(jobs).forEach(jobKey => {
            const job = jobs[jobKey];
            if (!jobTypes[job.type]) {
                jobTypes[job.type] = [];
            }
            jobTypes[job.type].push({key: jobKey, ...job});
        });
        
        Object.keys(jobTypes).forEach(type => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title">${getJobTypeName(type)}</h6>
                        </div>
                        <div class="card-body">
            `;
            
            jobTypes[type].forEach(job => {
                const isCurrent = job.key === currentJobType;
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="updateOption" id="job_${job.key}" value="${job.key}" ${isCurrent ? 'checked' : ''}>
                        <label class="form-check-label" for="job_${job.key}">
                            <strong>${job.name}</strong>
                            <br><small class="text-muted">${job.description}</small>
                        </label>
                    </div>
                    <hr class="my-2">
                `;
            });
            
            html += '</div></div></div>';
        });
        
        html += '</div>';
        optionsContainer.innerHTML = html;
    }
    
    function getJobTypeName(type) {
        const typeNames = {
            'basic': '基础数据',
            'indicators': '技术指标', 
            'pattern': 'K线形态',
            'strategy': '策略选股',
            'selection': '综合选股',
            'backtest': '策略回测',
            'complete': '完整更新'
        };
        return typeNames[type] || type;
    }
    
    function startSelectedJobUpdate() {
        const selectedOption = document.querySelector('input[name="updateOption"]:checked');
        if (!selectedOption) {
            alert('请选择更新选项');
            return;
        }
        
        const jobType = selectedOption.value;
        
        // 禁用开始按钮
        const startBtn = document.getElementById('startUpdateBtn');
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 更新中...';
        
        // 显示进度区域
        document.getElementById('updateStatusArea').style.display = 'block';
        
        // 发送更新请求
        fetch('/instock/job_update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                job_type: jobType
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                currentTaskId = result.task_id;
                document.getElementById('updateMessage').innerHTML = `
                    <i class="fa fa-check-circle text-success"></i> ${result.message}
                `;
                
                // 开始轮询状态
                startJobUpdatePolling();
            } else {
                throw new Error(result.message);
            }
        })
        .catch(error => {
            console.error('更新请求失败:', error);
            document.getElementById('updateMessage').innerHTML = `
                <i class="fa fa-exclamation-triangle text-danger"></i> 更新失败: ${error.message}
            `;
            
            // 恢复按钮状态
            setTimeout(() => {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fa fa-play"></i> 开始更新';
            }, 3000);
        });
    }
    
    function startJobUpdatePolling() {
        if (updatePollInterval) {
            clearInterval(updatePollInterval);
        }
        
        updatePollInterval = setInterval(() => {
            checkJobUpdateStatus();
        }, 2000); // 2秒检查一次
    }
    
    function checkJobUpdateStatus() {
        if (!currentTaskId) return;
        
        fetch(`/instock/job_update_status?task_id=${currentTaskId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const status = result.data;
                    
                    if (status.running) {
                        // 更新进度条
                        const progressBar = document.querySelector('.progress-bar');
                        progressBar.style.width = `${status.progress}%`;
                        progressBar.textContent = `${status.progress}%`;
                        progressBar.setAttribute('aria-valuenow', status.progress);
                        
                        document.getElementById('updateMessage').innerHTML = `
                            <i class="fa fa-spinner fa-spin text-primary"></i> ${status.message}
                        `;
                    } else {
                        // 任务完成
                        clearInterval(updatePollInterval);
                        updatePollInterval = null;
                        
                        const progressBar = document.querySelector('.progress-bar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        
                        if (status.success) {
                            document.getElementById('updateMessage').innerHTML = `
                                <i class="fa fa-check-circle text-success"></i> 更新完成！正在重新加载数据...
                            `;
                            
                            // 更新完成后重新加载数据
                            setTimeout(() => {
                                loadData(1);
                                $('#jobUpdateModal').modal('hide');
                            }, 2000);
                        } else {
                            document.getElementById('updateMessage').innerHTML = `
                                <i class="fa fa-exclamation-triangle text-danger"></i> 更新失败: ${status.message}
                            `;
                        }
                        
                        // 恢复按钮状态
                        const startBtn = document.getElementById('startUpdateBtn');
                        setTimeout(() => {
                            startBtn.disabled = false;
                            startBtn.innerHTML = '<i class="fa fa-play"></i> 开始更新';
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('检查更新状态失败:', error);
                clearInterval(updatePollInterval);
                updatePollInterval = null;
            });
    }
    
    function showJobOptionsError(message) {
        const optionsContainer = document.getElementById('jobUpdateOptions');
        optionsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fa fa-exclamation-triangle"></i>
                <strong>加载失败</strong>
                <p>${message}</p>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadJobUpdateOptions()">
                    <i class="fa fa-refresh"></i> 重试
                </button>
            </div>
        `;
    }
    
    // 模态框关闭时清理
    $('#jobUpdateModal').on('hidden.bs.modal', function () {
        if (updatePollInterval) {
            clearInterval(updatePollInterval);
            updatePollInterval = null;
        }
        currentTaskId = null;
        currentJobType = null;
        
        // 重置界面
        document.getElementById('updateStatusArea').style.display = 'none';
        const startBtn = document.getElementById('startUpdateBtn');
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fa fa-play"></i> 开始更新';
        startBtn.style.display = 'none';
        
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }
    });
    
    function checkDataStatus() {
        return new Promise((resolve, reject) => {
            fetch(`/instock/data_check?table=${nameParam}&date=${dateParam}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        resolve(result.has_data);
                    } else {
                        reject(new Error(result.message));
                    }
                })
                .catch(error => reject(error));
        });
    }
    
    function startDataUpdate() {
        // 禁用更新按钮
        const updateBtn = document.getElementById('updateDataBtn');
        const updateStatus = document.getElementById('updateStatus');
        
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<i class="fa fa-refresh fa-spin"></i> 更新中';
        updateStatus.style.display = 'inline';
        
        // 发送更新请求
        fetch('/instock/data_update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: getUpdateType()
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                updateTaskId = result.task_id;
                updateStatus.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 更新任务已开始';
                
                // 开始轮询任务状态
                startUpdateStatusPolling();
            } else {
                throw new Error(result.message);
            }
        })
        .catch(error => {
            console.error('更新请求失败:', error);
            updateStatus.innerHTML = '<i class="fa fa-exclamation-triangle"></i> 更新失败: ' + error.message;
            
            // 3秒后恢复按钮状态
            setTimeout(() => {
                resetUpdateButton();
            }, 3000);
        });
    }
    
    function getUpdateType() {
        // 根据当前页面类型确定更新类型
        const tableName = nameParam.toLowerCase();
        
        if (tableName.includes('selection')) {
            return 'selection'; // 综合选股
        } else if (tableName.includes('indicators')) {
            return 'indicators'; // 技术指标
        } else if (tableName.includes('kline')) {
            return 'kline'; // K线形态
        } else if (tableName.includes('strategy')) {
            return 'strategy'; // 策略数据
        } else if (tableName.includes('backtest')) {
            return 'backtest'; // 回测任务
        } else if (tableName.includes('after')) {
            return 'after_close'; // 收盘后数据
        } else if (tableName.includes('other')) {
            return 'basic_other'; // 其他基础数据
        } else if (tableName.includes('basic_data')) {
            return 'basic'; // 基础数据
        } else {
            return 'full'; // 默认执行完整更新
        }
    }
    
    function startUpdateStatusPolling() {
        if (updateCheckInterval) {
            clearInterval(updateCheckInterval);
        }
        
        updateCheckInterval = setInterval(() => {
            checkUpdateStatus();
        }, UPDATE_CHECK_INTERVAL);
    }
    
    function checkUpdateStatus() {
        fetch('/instock/data_update_status')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const status = result.data;
                    const updateStatus = document.getElementById('updateStatus');
                    
                    if (status.running) {
                        const details = status.progress_details || {};
                        let detailHtml = '';
                        Object.keys(details).forEach(key => {
                            const item = details[key];
                            if (!item) return;
                            const progress = item.progress ?? (item.total ? (item.current / item.total * 100).toFixed(2) : null);
                            detailHtml += `
                                <div>
                                    <span>${key}：</span>
                                    <span>${progress !== null ? progress + '%' : 'N/A'} - ${item.message || ''}</span>
                                </div>`;
                        });
                        updateStatus.innerHTML = `
                            <i class="fa fa-spinner fa-spin"></i> 
                            更新中... ${status.progress}% - ${status.message}
                            ${detailHtml ? `<div class="progress-details">${detailHtml}</div>` : ''}
                        `;
                    } else {
                        // 任务完成
                        clearInterval(updateCheckInterval);
                        updateCheckInterval = null;
                        
                        if (status.success) {
                            updateStatus.innerHTML = '<i class="fa fa-check-circle"></i> 更新完成';
                            
                            // 更新成功后重新加载数据
                            setTimeout(() => {
                                loadData(1);
                            }, 1000);
                        } else {
                            updateStatus.innerHTML = '<i class="fa fa-exclamation-triangle"></i> 更新失败: ' + status.message;
                        }
                        
                        // 3秒后恢复按钮状态
                        setTimeout(() => {
                            resetUpdateButton();
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('检查更新状态失败:', error);
                clearInterval(updateCheckInterval);
                updateCheckInterval = null;
                
                const updateStatus = document.getElementById('updateStatus');
                updateStatus.innerHTML = '<i class="fa fa-exclamation-triangle"></i> 状态检查失败';
                
                setTimeout(() => {
                    resetUpdateButton();
                }, 3000);
            });
    }
    
    function resetUpdateButton() {
        const updateBtn = document.getElementById('updateDataBtn');
        const updateStatus = document.getElementById('updateStatus');
        
        updateBtn.disabled = false;
        updateBtn.innerHTML = '<i class="fa fa-refresh"></i> 更新数据';
        updateStatus.style.display = 'none';
        updateStatus.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 更新中...';
        updateTaskId = null;
    }
    
    // 备用确认对话框
    function showFallbackConfirmationDialog() {
        const dateRange = prompt('请选择更新日期范围：\n1. 今日数据\n2. 最近3天\n3. 最近一周\n4. 最近一个月\n5. 所有近期数据\n\n请输入选项编号 (1-5):', '5');
        
        if (!dateRange) {
            return; // 用户取消
        }
        
        const dateRanges = {
            '1': {value: 'today', text: '今日数据'},
            '2': {value: 'last_3_days', text: '最近3天'},
            '3': {value: 'last_week', text: '最近一周'},
            '4': {value: 'last_month', text: '最近一个月'},
            '5': {value: 'all_recent', text: '所有近期数据'}
        };
        
        const selectedRange = dateRanges[dateRange];
        if (!selectedRange) {
            alert('无效的选项，请选择1-5之间的数字');
            return;
        }
        
        const confirmUpdate = confirm(`您选择了：${selectedRange.text}\n\n确认开始数据更新？\n\n注意：更新可能需要几分钟时间，建议在非交易高峰时段操作。`);
        
        if (confirmUpdate) {
            updateCurrentData(selectedRange.value, selectedRange.text);
        }
    }
    
    // 显示更新确认对话框
    function showUpdateConfirmationDialog() {
        // 创建模态对话框
        const modalHtml = `
            <div class="modal fade" id="updateConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="updateModalLabel">
                                <i class="fa fa-refresh"></i> 确认数据更新
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="updateDateRange">
                                    <i class="fa fa-calendar"></i> 选择更新日期范围:
                                </label>
                                <select class="form-control" id="updateDateRange">
                                    <option value="today">今日数据</option>
                                    <option value="last_3_days">最近3天</option>
                                    <option value="last_week">最近一周</option>
                                    <option value="last_month">最近一个月</option>
                                    <option value="all_recent">所有近期数据（建议）</option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle"></i> 更新可能需要几分钟时间，请耐心等待
                                </small>
                            </div>
                            <div class="alert alert-warning">
                                <i class="fa fa-exclamation-triangle"></i> 
                                <strong>请注意：</strong>数据更新期间可能影响系统性能，建议在非交易高峰时段操作
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fa fa-times"></i> 取消
                            </button>
                            <button type="button" class="btn btn-primary" onclick="confirmUpdate()">
                                <i class="fa fa-check"></i> 确认更新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 先检查jQuery和Bootstrap是否可用
        console.log('jQuery available:', typeof jQuery !== 'undefined');
        console.log('Bootstrap modal available:', typeof jQuery !== 'undefined' && typeof jQuery.fn.modal !== 'undefined');
        
        // 添加模态对话框到页面
        if (!document.getElementById('updateConfirmationModal')) {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // 简单直接的方法：使用原生JavaScript创建确认对话框
        showFallbackConfirmationDialog();
    }
    
    // 确认更新操作
    function confirmUpdate() {
        const dateRange = document.getElementById('updateDateRange').value;
        const dateRangeText = document.getElementById('updateDateRange').options[document.getElementById('updateDateRange').selectedIndex].text;
        
        // 关闭模态对话框
        $('#updateConfirmationModal').modal('hide');
        
        // 开始更新流程
        updateCurrentData(dateRange, dateRangeText);
    }
    
    // 更新当前数据
    function updateCurrentData(dateRange = 'today', dateRangeText = '今日数据') {
        updateStatusBar(`正在准备数据更新（${dateRangeText}）...`);
        showLoadingIndicator(`正在准备数据更新（${dateRangeText}）...`);
        
        // 获取当前表格名称
        const tableName = nameParam || 'current';
        
        // 查找对应的job类型
        fetch(`/instock/menu_to_job?table=${tableName}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.job_type) {
                    const jobType = data.data.job_type;
                    const jobInfo = data.data.job_info;
                    
                    // 调用job更新API
                    fetch('/instock/job_update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ job_type: jobType })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            updateStatusBar(`${jobInfo.name}已开始执行`);
                            
                            // 显示任务状态
                            const updateStatus = document.getElementById('updateStatus');
                            if (updateStatus) {
                                updateStatus.innerHTML = `
                                    <div style="background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 6px; margin: 10px 0;">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <span><i class="fa fa-spinner fa-spin"></i> ${jobInfo.name}执行中...</span>
                                            <span style="font-size: 12px; color: #666;">ID: ${result.task_id}</span>
                                        </div>
                                        <div style="background: #e9ecef; height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                                            <div id="updateProgressBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                                updateStatus.style.display = 'block';
                            }
                            
                            // 开始轮询任务状态
                            const taskId = result.task_id;
                            let progressCheckInterval = setInterval(() => {
                                fetch(`/instock/job_update_status?task_id=${taskId}`)
                                    .then(response => response.json())
                                    .then(statusData => {
                                        if (statusData.success) {
                                            const taskInfo = statusData.data;
                                            
                                            // 更新进度条
                                            const progressBar = document.getElementById('updateProgressBar');
                                            if (progressBar) {
                                                progressBar.style.width = taskInfo.progress + '%';
                                            }
                                            
                                            // 更新状态信息
                                            if (updateStatus) {
                                                const statusIcon = taskInfo.running ? 'fa-spinner fa-spin' : 
                                                                   taskInfo.success ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-danger';
                                                const statusText = taskInfo.running ? '执行中' : 
                                                                  taskInfo.success ? '完成' : '失败';
                                                
                                                updateStatus.innerHTML = `
                                                    <div style="background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 6px; margin: 10px 0;">
                                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                                            <span><i class="fa ${statusIcon}"></i> ${jobInfo.name} ${statusText}</span>
                                                            <span style="font-size: 12px; color: #666;">进度: ${taskInfo.progress}%</span>
                                                        </div>
                                                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${taskInfo.message}</div>
                                                        <div style="background: #e9ecef; height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                                                            <div id="updateProgressBar" style="background: ${taskInfo.success ? '#28a745' : taskInfo.running ? '#17a2b8' : '#dc3545'}; height: 100%; width: ${taskInfo.progress}%; transition: width 0.3s;"></div>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            
                                            // 任务完成后的处理
                                            if (!taskInfo.running) {
                                                clearInterval(progressCheckInterval);
                                                
                                                // 2秒后自动重新加载数据
                                                setTimeout(() => {
                                                    if (updateStatus) {
                                                        updateStatus.style.display = 'none';
                                                    }
                                                    hideLoadingIndicator();
                                                    loadData(1); // 重新加载数据
                                                    updateStatusBar('数据更新完成，已重新加载');
                                                }, 2000);
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error('检查任务状态失败:', error);
                                        clearInterval(progressCheckInterval);
                                        if (updateStatus) {
                                            updateStatus.innerHTML = '<i class="fa fa-exclamation-triangle text-danger"></i> 状态检查失败';
                                        }
                                        hideLoadingIndicator();
                                    });
                            }, 2000); // 每2秒检查一次
                            
                        } else {
                            updateStatusBar(`更新失败: ${result.message}`);
                            hideLoadingIndicator();
                        }
                    })
                    .catch(error => {
                        console.error('更新请求失败:', error);
                        updateStatusBar('更新请求失败');
                        hideLoadingIndicator();
                    });
                    
                } else {
                    updateStatusBar('未找到对应的更新任务');
                    hideLoadingIndicator();
                }
            })
            .catch(error => {
                console.error('获取job映射失败:', error);
                updateStatusBar('获取更新配置失败');
                hideLoadingIndicator();
            });
    }
    
    // 修改空数据页面的更新按钮
    function showEmptyDataMessage() {
        const container = document.getElementById('luckysheet');
        if (container) {
            const tableName = nameParam || '当前';
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                    <div style="text-align: center; color: #6c757d; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                        <div style="margin-bottom: 20px;">
                            <i class="fa fa-database" style="font-size: 48px; color: #667eea;"></i>
                        </div>
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">暂无数据</h4>
                        <p style="margin-bottom: 20px; color: #6c757d;">当前日期 <strong>${dateParam}</strong> 没有找到相关数据</p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="loadData(1)" class="btn btn-primary btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                <i class="fa fa-refresh"></i> 重新加载
                            </button>
                            <button onclick="loadLatestData()" class="btn btn-info btn-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                <i class="fa fa-clock-o"></i> 加载最新数据
                            </button>
                            <button onclick="showUpdateConfirmationDialog()" class="btn btn-warning btn-sm" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border: none; border-radius: 6px; padding: 8px 16px;">
                                <i class="fa fa-refresh"></i> 立即更新
                            </button>
                        </div>
                        <div style="margin-top: 20px; font-size: 12px; color: #999;">
                            <i class="fa fa-info-circle"></i> 提示：可以尝试选择其他日期或重新加载数据
                        </div>
                    </div>
                </div>
            `;
        }
    }
</script>
{% end %}
