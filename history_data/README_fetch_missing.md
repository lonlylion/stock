# 缺失股票数据爬取工具使用说明 (多线程批处理版本)

## 功能介绍

`fetch_missing_stocks.py` 是一个多线程股票历史数据爬取工具，专门用于获取ClickHouse数据库中缺失的股票历史数据。

## 主要特性

- **多线程并发**: 默认使用5个线程，可自定义线程数
- **批处理入库**: 每个线程处理完50只股票后立即入库
- **线程独立**: 每个线程独立工作，避免竞争和阻塞
- **内存可控**: 避免大量数据占用内存，实时入库
- **智能过滤**: 自动跳过北京交易所股票（baostock暂不支持）
- **线程安全**: 线程安全的日志输出和统计更新
- **详细统计**: 提供详细的进度显示和错误统计

## 使用方法

### 基本用法
```bash
# 使用默认配置 (5个线程，每50只股票入库一次)
python3 fetch_missing_stocks.py

# 指定线程数和批处理大小
python3 fetch_missing_stocks.py --threads 8 --batch-size 30

# 使用简写
python3 fetch_missing_stocks.py -t 3 -b 20
```

### 命令行参数

- `--threads, -t`: 并发线程数（默认: 5）
- `--max-threads`: 最大允许线程数（默认: 10）
- `--batch-size, -b`: 每个线程批处理大小（默认: 50）
- `--help, -h`: 显示帮助信息

### 示例

```bash
# 使用3个线程，每20只股票入库一次
python3 fetch_missing_stocks.py -t 3 -b 20

# 使用8个线程，每100只股票入库一次
python3 fetch_missing_stocks.py --threads 8 --batch-size 100

# 小批量处理，减少内存占用
python3 fetch_missing_stocks.py -t 2 -b 10
```

## 前置条件

1. **缺失股票列表**: 需要先运行 `deal_clickhouse_data.py` 生成 `missing_stock_data.csv` 文件
2. **依赖库**: 确保安装了所需的Python库
   ```bash
   pip install pandas baostock clickhouse-connect
   ```
3. **ClickHouse连接**: 确保ClickHouse数据库连接正常

## 工作流程

1. 读取 `missing_stock_data.csv` 文件
2. 过滤掉北京交易所(BJ)的股票
3. 将所有股票任务添加到队列中
4. 启动多个工作线程，每个线程从队列中获取任务
5. 每个线程独立爬取数据，处理完指定数量的股票后立即入库
6. 所有线程完成后汇总统计信息

## 输出信息

```
=== 缺失股票数据爬取工具 (多线程批处理版本) ===
开始时间: 2025-08-31 14:30:00.123456
并发线程数: 5
批处理大小: 50 只股票/批次
读取缺失股票数据: /path/to/missing_stock_data.csv
总缺失股票: 500 只
北京交易所股票: 200 只 (跳过)
待处理股票: 300 只 (上海+深圳)
已将 300 只股票添加到任务队列

线程 1 开始工作
线程 2 开始工作
...
线程1 [1/300] 处理股票: 600000(SH)
线程2 [2/300] 处理股票: 000001(SZ)
...
线程1 开始批量入库 50 只股票的数据...
线程1 插入 123,456 条记录，耗时: 2.35 秒
线程1 批量入库成功
...

=== 数据获取完成 ===
成功: 295 只股票
失败: 5 只股票
总记录数: 1,234,567
所有数据已在线程中实时入库完成

程序结束时间: 2025-08-31 14:45:30.789012
```

## 批处理策略

### 批处理大小选择
- **小批量 (10-20)**: 适合内存较小的环境，入库更频繁
- **中批量 (50)**: 默认推荐，平衡内存使用和入库效率  
- **大批量 (100+)**: 适合内存充足的环境，减少入库次数

### 线程数选择
- **网络带宽有限**: 使用较少线程 (2-3)
- **网络状况良好**: 可增加线程数 (5-8)
- **避免过多线程**: 超过10个线程可能导致请求频率过高

## 注意事项

1. **批处理优势**: 避免内存占用过大，实时入库提高数据可靠性
2. **线程独立性**: 每个线程独立工作，一个线程失败不影响其他线程
3. **网络稳定性**: 确保网络连接稳定，避免频繁的网络错误
4. **数据源限制**: baostock对请求频率可能有限制，适当控制线程数

## 故障排除

### 常见问题

1. **找不到missing_stock_data.csv**
   - 先运行 `deal_clickhouse_data.py` 生成缺失股票列表

2. **baostock登录失败** 
   - 检查网络连接
   - 稍后重试

3. **ClickHouse连接失败**
   - 检查数据库配置
   - 确认数据库服务正常运行

4. **内存不足**
   - 减少线程数
   - 分批处理数据

### 性能优化

- 根据网络带宽调整线程数
- 在网络状况好的时候运行
- 定期清理失败的任务重新运行
